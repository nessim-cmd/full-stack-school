generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  output          = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["support_service"]
}

model SupportTicket {
  id       String  @id @default(uuid())
  ticketNo String  @unique
  schoolId String? // null for platform-level tickets

  // Requester
  userId    String
  userType  String // "admin", "teacher", "parent", "student"
  userName  String
  userEmail String

  // Ticket Details
  subject     String
  description String         @db.Text
  category    TicketCategory @default(GENERAL)
  priority    TicketPriority @default(MEDIUM)
  status      TicketStatus   @default(OPEN)

  // Assignment
  assignedTo String?
  assignedAt DateTime?

  // Resolution
  resolvedAt DateTime?
  resolution String?   @db.Text

  // Messages
  messages    TicketMessage[]
  attachments TicketAttachment[]

  // Ratings
  rating   Int? // 1-5
  feedback String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@schema("support_service")
}

model TicketMessage {
  id       String        @id @default(uuid())
  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  senderId   String
  senderType String // "user", "support", "system"
  senderName String
  message    String  @db.Text
  isInternal Boolean @default(false) // Internal notes for support team

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@schema("support_service")
}

model TicketAttachment {
  id       String        @id @default(uuid())
  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  name     String
  url      String
  mimeType String?
  size     Int?

  uploadedBy String
  uploadedAt DateTime @default(now())

  @@schema("support_service")
}

model KnowledgeBase {
  id      String  @id @default(uuid())
  title   String
  slug    String  @unique
  content String  @db.Text
  excerpt String?

  category String
  tags     String[]

  isPublished  Boolean @default(false)
  viewCount    Int     @default(0)
  helpfulCount Int     @default(0)

  authorId   String
  authorName String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isPublished])
  @@schema("support_service")
}

model FAQ {
  id        String @id @default(uuid())
  question  String
  answer    String @db.Text
  category  String
  sortOrder Int    @default(0)

  isPublished Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@schema("support_service")
}

enum TicketCategory {
  GENERAL
  BILLING
  TECHNICAL
  FEATURE_REQUEST
  BUG_REPORT
  ACCOUNT
  INTEGRATION
  OTHER

  @@schema("support_service")
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT

  @@schema("support_service")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_CUSTOMER
  WAITING_FOR_THIRD_PARTY
  RESOLVED
  CLOSED

  @@schema("support_service")
}
