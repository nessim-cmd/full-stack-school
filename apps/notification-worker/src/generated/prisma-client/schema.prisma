generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  output          = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["notification_worker"]
}

model NotificationJob {
  id     String           @id @default(uuid())
  type   NotificationType
  status JobStatus        @default(PENDING)

  // Target
  schoolId  String?
  userId    String?
  userEmail String?
  userPhone String?

  // Content
  subject String?
  title   String
  body    String  @db.Text
  data    Json?

  // Channel
  channels String[] @default(["push"]) // "push", "email", "sms"

  // Scheduling
  scheduledFor DateTime?
  processedAt  DateTime?

  // Retry
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  lastError   String?
  nextRetryAt DateTime?

  // Priority
  priority Int @default(0) // Higher = more priority

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
  @@schema("notification_worker")
}

model NotificationTemplate {
  id   String @id @default(uuid())
  name String @unique
  type String // "email", "push", "sms"

  subject String? // For emails
  title   String? // For push notifications
  body    String  @db.Text

  // Variables: {{name}}, {{schoolName}}, etc.
  variables String[]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("notification_worker")
}

model EmailLog {
  id    String  @id @default(uuid())
  jobId String?

  to      String
  from    String
  subject String
  body    String @db.Text

  status   String // "sent", "failed", "bounced"
  provider String? // "sendgrid", "ses", "smtp"

  sentAt DateTime?
  error  String?

  createdAt DateTime @default(now())

  @@index([status])
  @@index([to])
  @@schema("notification_worker")
}

model PushLog {
  id    String  @id @default(uuid())
  jobId String?

  userId String
  token  String?

  title String
  body  String
  data  Json?

  status String // "sent", "failed", "invalid_token"

  sentAt DateTime?
  error  String?

  createdAt DateTime @default(now())

  @@index([status])
  @@index([userId])
  @@schema("notification_worker")
}

model SmsLog {
  id    String  @id @default(uuid())
  jobId String?

  to   String
  from String?
  body String

  status   String // "sent", "failed", "delivered"
  provider String? // "twilio", "nexmo"

  sentAt DateTime?
  error  String?

  createdAt DateTime @default(now())

  @@index([status])
  @@index([to])
  @@schema("notification_worker")
}

model DeviceToken {
  id       String @id @default(uuid())
  userId   String
  token    String @unique
  platform String // "ios", "android", "web"

  isActive Boolean  @default(true)
  lastUsed DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@schema("notification_worker")
}

enum NotificationType {
  ANNOUNCEMENT
  MESSAGE
  ALERT
  REMINDER
  SYSTEM
  MARKETING

  @@schema("notification_worker")
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED

  @@schema("notification_worker")
}
