
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SuperAdmin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  auditLogs AuditLog[]
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String   // "school_created", "school_suspended", "plan_changed", etc.
  entity      String   // "school", "user", "subscription", etc.
  entityId    String
  description String
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())
  
  superAdminId String
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)
}

model School {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique // subdomain
  domain          String?  @unique // custom domain
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Subscription
  plan            PlanType @default(FREE)
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt     DateTime
  subscriptionEndsAt DateTime?
  
  // Relations
  admins          Admin[]
  students        Student[]
  teachers        Teacher[]
  parents         Parent[]
  grades          Grade[]
  classes         Class[]
  subjects        Subject[]
  lessons         Lesson[]
  exams           Exam[]
  assignments     Assignment[]
  results         Result[]
  attendances     Attendance[]
  events          Event[]
  announcements   Announcement[]
  resources       Resource[]
  notifications   Notification[]
  messages        Message[]
  registrationRequests RegistrationRequest[]
  invoices        Invoice[]
  tickets         SupportTicket[]
  
  settings        SiteSettings?
  memberships     SchoolMembership[]
  
  // Finance
  feeCategories   FeeCategory[]
  feeStructures   FeeStructure[]
  studentInvoices StudentInvoice[]
  payments        Payment[]
  
  // Teacher Payroll
  payrollRates    TeacherPayrollRate[]
  payrolls        TeacherPayroll[]
}


model SchoolManager {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  schools   SchoolMembership[]
}

model SchoolMembership {
  id        String   @id @default(uuid())
  
  managerId String
  manager   SchoolManager @relation(fields: [managerId], references: [id], onDelete: Cascade)
  
  schoolId  String
  school    School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  role      String @default("owner") // "owner", "admin", etc.
  createdAt DateTime @default(now())
  
  @@unique([managerId, schoolId])
}

enum PlanType {
  FREE
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
}

model Admin {
  id       String @id
  username String @unique
  password String @default("")
  
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Student {
  id          String       @id
  username    String       @unique
  password    String       @default("")
  name        String
  surname     String
  email       String?      @unique
  phone       String?      @unique
  address     String
  img         String?
  bloodType   String
  sex         UserSex
  createdAt   DateTime     @default(now())
  parentId    String
  parent      Parent       @relation(fields: [parentId], references: [id])
  classId     Int
  class       Class        @relation(fields: [classId], references: [id])
  gradeId     Int
  grade       Grade        @relation(fields: [gradeId], references: [id])
  attendances Attendance[]
  results     Result[]
  invoices    StudentInvoice[]
  birthday    DateTime

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Teacher {
  id        String @id
  username  String @unique
  password  String @default("")
  name      String
  surname   String
  email     String?   @unique
  phone     String?   @unique
  address   String
  img       String?
  bloodType String
  sex       UserSex
  createdAt DateTime  @default(now())
  subjects  Subject[]
  lessons   Lesson[]
  classes   Class[]
  birthday  DateTime

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  payrollRates TeacherPayrollRate[]
  payrolls     TeacherPayroll[]
}

model Parent {
  id        String    @id
  username  String    @unique
  password  String    @default("")
  name      String
  surname   String
  email     String?   @unique
  phone     String    @unique
  address   String
  createdAt DateTime  @default(now())
  students  Student[]

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}


model Grade {
  id    Int @id @default(autoincrement())
  level Int
  
  students Student[]
  classess Class[]
  feeStructures FeeStructure[]

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([level, schoolId])
}

model Class {
  id       Int    @id @default(autoincrement())
  name     String
  capacity Int

  supervisorId  String?
  supervisor    Teacher?       @relation(fields: [supervisorId], references: [id])
  lessons       Lesson[]
  students      Student[]
  gradeId       Int
  grade         Grade          @relation(fields: [gradeId], references: [id])
  events        Event[]
  announcements Announcement[]

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([name, schoolId])
}

model Subject {
  id       Int       @id @default(autoincrement())
  name     String
  teachers Teacher[]
  lessons  Lesson[]

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([name, schoolId])
}


model Lesson {
  id        Int      @id @default(autoincrement())
  name      String
  day       Day
  startTime DateTime
  endTime   DateTime

  subjectId   Int
  subject     Subject      @relation(fields: [subjectId], references: [id])
  classId     Int
  class       Class        @relation(fields: [classId], references: [id])
  teacherId   String
  teacher     Teacher      @relation(fields: [teacherId], references: [id])
  exams       Exam[]
  assignments Assignment[]
  attendances Attendance[]
  resources   Resource[]

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Exam {
  id        Int      @id @default(autoincrement())
  title     String
  startTime DateTime
  endTime   DateTime

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Assignment {
  id        Int      @id @default(autoincrement())
  title     String
  startDate DateTime
  dueDate   DateTime

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
  resources Resource[]

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Result {
  id    Int @id @default(autoincrement())
  score Int

  examId       Int?
  exam         Exam?       @relation(fields: [examId], references: [id])
  assignmentId Int?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  studentId    String
  student      Student     @relation(fields: [studentId], references: [id])

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Resource {
  id        Int      @id @default(autoincrement())
  title     String
  url       String
  createdAt DateTime @default(now())

  lessonId     Int?
  lesson       Lesson?     @relation(fields: [lessonId], references: [id])
  assignmentId Int?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}


model Attendance {
  id      Int      @id @default(autoincrement())
  date    DateTime
  present Boolean

  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  lessonId  Int
  lesson    Lesson  @relation(fields: [lessonId], references: [id])

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  startTime   DateTime
  endTime     DateTime

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Announcement {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  date        DateTime

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Notification {
  id          Int      @id @default(autoincrement())
  title       String
  message     String
  type        String   // "password_change", "absence", "general"
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  // Polymorphic relationship - userId can be admin, teacher, student, or parent
  userId      String
  userRole    String   // "admin", "teacher", "student", "parent"

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Message {
  id        Int      @id @default(autoincrement())
  subject   String
  content   String
  createdAt DateTime @default(now())

  senderId    String
  senderName  String
  senderRole  String

  recipients MessageRecipient[]

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model MessageRecipient {
  id            String   @id @default(uuid())
  messageId     Int
  message       Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  recipientId   String
  recipientName String
  recipientRole String // "admin", "teacher", "student", "parent"
  
  read          Boolean  @default(false)
}

enum UserSex {
  MALE
  FEMALE
}

enum Day {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
}


model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  token     String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model RegistrationRequest {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  status    RequestStatus @default(PENDING)

  // Student Info
  studentName      String
  studentSurname   String
  studentEmail     String?
  studentPhone     String?
  studentAddress   String
  studentBloodType String
  studentSex       UserSex
  studentBirthday  DateTime
  gradeId          Int

  // Parent Info
  parentName    String
  parentSurname String
  parentEmail   String
  parentPhone   String
  parentAddress String

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model SiteSettings {
  id String @id @default(uuid())
  
  // Branding
  schoolName        String @default("SchoolHub")
  schoolLogo        String? // URL to logo image
  schoolTagline     String @default("Excellence in Education Since 1995")
  
  // Hero Section
  heroTitle         String @default("Welcome to SchoolHub")
  heroDescription   String @default("Empowering students to achieve their full potential through innovative learning, dedicated teachers, and a nurturing environment. Join our community of excellence.")
  heroImage         String? // URL to hero image
  
  // Stats
  totalStudents     String @default("2,500+")
  totalTeachers     String @default("150+")
  successRate       String @default("98%")
  yearsExperience   String @default("30+")
  
  // About Section
  missionTitle      String @default("Our Mission")
  missionText       String @default("To provide world-class education that nurtures critical thinking, creativity, and character development in every student.")
  visionTitle       String @default("Our Vision")
  visionText        String @default("To be the leading educational institution that prepares students for global citizenship and lifelong success.")
  valuesTitle       String @default("Our Values")
  valuesText        String @default("Excellence, Integrity, Innovation, Respect, and Community - the pillars that guide everything we do.")
  
  // Programs (JSON array of {grade, range, description, color})
  programs          String @default("[{\"grade\":\"Elementary\",\"range\":\"Grades 1-5\",\"description\":\"Building strong foundations in core subjects with engaging, hands-on learning.\",\"color\":\"from-green-400 to-emerald-500\"},{\"grade\":\"Middle School\",\"range\":\"Grades 6-8\",\"description\":\"Developing critical thinking and preparing for advanced academic challenges.\",\"color\":\"from-blue-400 to-cyan-500\"},{\"grade\":\"High School\",\"range\":\"Grades 9-12\",\"description\":\"College preparation with AP courses and comprehensive career guidance.\",\"color\":\"from-purple-400 to-pink-500\"}]")
  
  // Certifications (JSON array of strings)
  certifications    String @default("[\"International Baccalaureate\",\"Ministry of Education\",\"Cambridge Assessment\",\"ISO 9001:2015 Certified\"]")
  
  // Contact Information
  address           String @default("123 Education Street, Knowledge City, KC 12345")
  phone             String @default("+1 (555) 123-4567")
  email             String @default("info@schoolhub.edu")
  
  // Social Media
  facebookUrl       String?
  twitterUrl        String?
  instagramUrl      String?
  
  // CTA Section
  ctaTitle          String @default("Ready to Join Our Community?")
  ctaDescription    String @default("Start your journey towards academic excellence today. Apply now and become part of our thriving educational family.")
  
  updatedAt         DateTime @updatedAt

  schoolId String @unique
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Invoice {
  id        String   @id @default(uuid())
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  amount    Float
  status    InvoiceStatus @default(PENDING)
  dueDate   DateTime
  paidAt    DateTime?
  plan      PlanType
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model GlobalAnnouncement {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   @default("INFO") // INFO, WARNING, CRITICAL
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SupportTicket {
  id        String   @id @default(uuid())
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject   String
  message   String
  status    TicketStatus @default(OPEN)
  priority  TicketPriority @default(MEDIUM)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  replies   SupportTicketReply[]
}

model SupportTicketReply {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  message   String
  isAdmin   Boolean  // true if reply is from Super Admin, false if from School Admin
  createdAt DateTime @default(now())
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SaasSettings {
  id String @id @default(uuid())
  
  // Hero
  heroTitle       String @default("Modern School Management Made Simple")
  heroDescription String @default("Complete school management solution with student tracking, attendance, grades, messaging, and more. Get started in minutes with our powerful SaaS platform.")
  
  // Features (JSON)
  features        String @default("[]") // JSON array
  
  // Pricing (JSON)
  pricing         String @default("[]") // JSON array
  
  updatedAt       DateTime @updatedAt
}

model FeeCategory {
  id          Int      @id @default(autoincrement())
  name        String   // e.g., "Tuition Fee", "Bus Fee"
  description String?
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  feeStructures FeeStructure[]
}

model FeeStructure {
  id            Int      @id @default(autoincrement())
  amount        Float
  
  feeCategoryId Int
  feeCategory   FeeCategory @relation(fields: [feeCategoryId], references: [id])
  
  // Link to Grade or Class (usually fees are per grade)
  gradeId       Int?
  grade         Grade?   @relation(fields: [gradeId], references: [id])
  
  schoolId      String
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model StudentInvoice {
  id          String   @id @default(uuid())
  title       String   // e.g. "Term 1 Tuition"
  amount      Float
  status      InvoiceStatus @default(PENDING)
  dueDate     DateTime
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id])
  
  payments    Payment[]
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Payment {
  id               String   @id @default(uuid())
  amount           Float
  date             DateTime @default(now())
  method           PaymentMethod // CASH, BANK_TRANSFER, CHECK, ONLINE
  
  invoiceId        String
  invoice          StudentInvoice @relation(fields: [invoiceId], references: [id])
  
  schoolId         String
  school           School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHECK
  ONLINE
}

// ============ TEACHER PAYROLL MODELS ============

model TeacherPayrollRate {
  id          String   @id @default(uuid())
  hourlyRate  Float    // Price per hour
  effectiveFrom DateTime @default(now())
  effectiveTo DateTime?
  
  teacherId   String
  teacher     Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  schoolId    String
  school      School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeacherPayroll {
  id                String   @id @default(uuid())
  
  // Basic info
  month             Int      // 1-12
  year              Int
  status            PayrollStatus @default(PENDING)
  
  // Calculations
  totalHours        Float
  hourlyRate        Float
  baseSalary        Float   // totalHours * hourlyRate
  totalDeductions   Float   @default(0)
  netSalary         Float   // baseSalary - totalDeductions
  
  // Payment info
  paidAt            DateTime?
  paymentMethod     PaymentMethod?
  notes             String?
  
  // Relations
  teacherId         String
  teacher           Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  deductions        PayrollDeduction[]
  
  schoolId          String
  school            School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([teacherId, month, year, schoolId])
}

model PayrollDeduction {
  id            String   @id @default(uuid())
  reason        String   // "Tax", "Insurance", "Late Fee", "Absence Penalty", etc.
  amount        Float
  notes         String?
  
  payrollId     String
  payroll       TeacherPayroll @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum PayrollStatus {
  PENDING
  CALCULATED
  APPROVED
  PAID
  CANCELLED
}
